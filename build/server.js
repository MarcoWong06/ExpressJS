"use strict";var B=Object.create;var E=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var V=Object.getOwnPropertyNames;var F=Object.getPrototypeOf,G=Object.prototype.hasOwnProperty;var Y=(e,t)=>{for(var r in t)E(e,r,{get:t[r],enumerable:!0})},N=(e,t,r,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of V(t))!G.call(e,o)&&o!==r&&E(e,o,{get:()=>t[o],enumerable:!(s=M(t,o))||s.enumerable});return e};var d=(e,t,r)=>(r=e!=null?B(F(e)):{},N(t||!e||!e.__esModule?E(r,"default",{value:e,enumerable:!0}):r,e)),J=e=>N(E({},"__esModule",{value:!0}),e);var te={};Y(te,{default:()=>ee});module.exports=J(te);var T=d(require("express"),1),L=d(require("helmet"),1),v=d(require("cors"),1);var x=require("express");var D=require("express");var U=d(require("express"),1);var R=d(require("jsrsasign"),1),Q=e=>e.startsWith("-----BEGIN PRIVATE KEY-----")?e:`-----BEGIN PRIVATE KEY-----
${e}
-----END PRIVATE KEY-----`,f=({requestMethod:e,requestUri:t,timestamp:r,nonceStr:s,merchantCode:o,body:m},l)=>{try{let g=`${e}
${t}
${r}
${s}
${o}
${m}
`,c=Q(l),p=new R.KJUR.crypto.Signature({alg:"SHA256withRSA"});return p.init(c),p.updateString(g),R.hextob64(p.sign())}catch(g){throw console.error("Signature generation failed:",g),new Error("Failed to generate signature")}},C=()=>({timestamp:Date.now(),nonceStr:Math.random().toString(36).substring(2,34)}),I=(e,t,r,s,o,m)=>{let l=new URLSearchParams({managedOrderNo:t,"K-Merchant-Code":r,"K-Nonce-Str":s,"K-Timestamp":o.toString(),"K-Signature":m});return`${e}?${l.toString()}`};var i=class extends Error{constructor(t){super(t),this.name="ValidationError"}},w=e=>{let t=["language","kpayApiKey","merchantCode","payAmount"];for(let r of t)if(!e[r])throw new i(`Missing required field: ${r}`);if(typeof e.payAmount!="number"||e.payAmount<=0)throw new i("payAmount must be a positive number");if(e.discountAmount!==null&&e.discountAmount!==void 0&&(typeof e.discountAmount!="number"||e.discountAmount<0))throw new i("discountAmount must be a non-negative number");if(e.email&&!W(e.email))throw new i("Invalid email format");if(e.phone&&!z(e.phone))throw new i("Invalid phone format")},W=e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),z=e=>/^[2-9]\d{7}$/.test(e);var O=d(require("axios"),1);var n={API:{BASE_URL:"https://payment.uat.kpay-group.com",ENDPOINTS:{CREATE_ALL_HOSTED_CHECKOUT_ORDER:"/v1/managed/order/add",GENERATE_ALL_HOSTED_CHECKOUT_ORDER:"/v1/web/managed/order"},SUCCESS_CODES:[1e4,"10000"]},DEFAULTS:{CURRENCY:"HKD"},TIMEOUTS:{REQUEST:3e4}};var a=class extends Error{constructor(r,s,o){super(r);this.statusCode=s;this.apiCode=o;this.name="KPayApiError"}},A=class{baseURL=n.API.BASE_URL;timeout=n.TIMEOUTS.REQUEST;async createOrder(t,r){try{let s=await O.default.post(`${this.baseURL}${n.API.ENDPOINTS.CREATE_ALL_HOSTED_CHECKOUT_ORDER}`,t,{headers:r,timeout:this.timeout});if(!s.data)throw new a("Invalid response from payment API - no data received");let{code:o,message:m}=s.data;if(!n.API.SUCCESS_CODES.includes(o))throw new a(`Payment API error: ${m||o}`,s.status,o);return s.data}catch(s){if(s instanceof a)throw s;if(O.default.isAxiosError(s)){let o=s;throw new a(`API request failed: ${o.message}`,o.response?.status,o.code)}throw new a("Unknown error occurred during API request")}}},P=e=>({"K-Merchant-Code":e.MerchantCode,"K-Nonce-Str":e.NonceStr,"K-Timestamp":e.Timestamp,"K-Signature":e.Signature,"K-Language":e.Language});var _=U.default.Router(),X=new A,Z=e=>({merchantIcon:e.merchantIcon,managedOutTradeNo:`order_${Date.now()}`,payAmount:e.payAmount,payCurrency:n.DEFAULTS.CURRENCY,discountAmount:e.discountAmount,notifyUrl:e.notifyUrl,returnUrl:e.returnUrl,orderRemark:e.orderRemark,itemList:[{itemNo:e.itemNo,itemName:e.itemName,itemIcon:e.itemIcon,price:e.payAmount+(e.discountAmount||0),priceCurrency:n.DEFAULTS.CURRENCY,quantity:e.quantity}]});_.post("/",async(e,t)=>{try{w(e.body);let r=Z(e.body),{timestamp:s,nonceStr:o}=C(),m=JSON.stringify(r),l=f({requestMethod:"POST",requestUri:n.API.ENDPOINTS.CREATE_ALL_HOSTED_CHECKOUT_ORDER,body:m,merchantCode:e.body.merchantCode,timestamp:s,nonceStr:o},e.body.kpayApiKey),g=P({MerchantCode:e.body.merchantCode,NonceStr:o,Timestamp:s.toString(),Signature:l,Language:e.body.language}),c=await X.createOrder(r,g);if(!n.API.SUCCESS_CODES.includes(c.code)||!c.data)throw new a(`Failed to create order: ${c.message} with code ${c.code}`,void 0,c.code);let p=c.data.managedOrderNo,{timestamp:S,nonceStr:h}=C(),b=f({requestMethod:"GET",requestUri:`${n.API.ENDPOINTS.GENERATE_ALL_HOSTED_CHECKOUT_ORDER}?managedOrderNo=${p}&K-Merchant-Code=${e.body.merchantCode}&K-Nonce-Str=${h}&K-Timestamp=${S}`,body:"",merchantCode:e.body.merchantCode,timestamp:S,nonceStr:h},e.body.kpayApiKey),j=I(`${n.API.BASE_URL}${n.API.ENDPOINTS.GENERATE_ALL_HOSTED_CHECKOUT_ORDER}`,p,e.body.merchantCode,h,S,b);t.status(200).json({message:"Hosted checkout order created successfully",checkoutUrl:j})}catch(r){if(console.error("Error processing hosted checkout order:",r),r instanceof i){t.status(400).json({message:"Validation Error",error:r.message});return}if(r instanceof a){t.status(r.statusCode||502).json({message:"Payment API Error",error:r.message});return}t.status(500).json({message:"Internal Server Error",error:r instanceof Error?r.message:"Unknown error occurred"})}});var k=_;var H=(0,D.Router)();H.use("/checkout",k);var K=H;var y=(0,x.Router)();y.get("/",(e,t)=>{t.status(200).json({status:"OK",message:"API Service is healthy",timestamp:new Date().toISOString()})});y.use("/v1/kpay",K);var $=y;var u=(0,T.default)(),q=parseInt(process.env.PORT||"3000",10);u.use((0,L.default)({contentSecurityPolicy:{directives:{defaultSrc:["'self'"],scriptSrc:["'self'"],styleSrc:["'self'","'unsafe-inline'"],imgSrc:["'self'","data:"],fontSrc:["'self'"],objectSrc:["'none'"],upgradeInsecureRequests:[]}}}));u.use((0,v.default)({origin:["http://localhost"],credentials:!0}));u.use(T.default.json());u.get("/",(e,t)=>{t.send("cap-cws-express")});u.get("/health",(e,t)=>{t.status(200).json({status:"OK",message:"Service is healthy",timestamp:new Date().toISOString()})});u.use("/api",$);u.listen(q,"0.0.0.0",()=>{console.log(`\u670D\u52D9\u5668\u904B\u884C\u5728 http://localhost:${q}`),console.log("\u74B0\u5883: production")});var ee=u;
